<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画情報検索ステーション - AI詳細解説付き</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interフォントを使用 -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark mode background */
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            -webkit-line-clamp: 2;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            -webkit-line-clamp: 3;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="p-4 md:p-8">
        <!-- ヘッダーとタイトル -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-indigo-400 tracking-tight mb-2">
                動画情報検索ステーション
            </h1>
            <p class="text-gray-400 text-lg">
                YouTube動画の情報をキーワードで検索し、AIで詳細に解説します。
            </p>
            <p class="mt-4 text-sm text-red-400 font-bold">
                <!-- 法的リスクに関する注意書き -->
                【重要】著作権の有無に関わらず、動画をダウンロードする機能は、利用規約および法令により実装できません。
            </p>
        </header>

        <!-- 検索フォーム -->
        <div class="max-w-3xl mx-auto bg-gray-800 p-6 rounded-2xl shadow-2xl">
            <div class="flex flex-col md:flex-row gap-4">
                <input
                    id="searchInput"
                    type="text"
                    placeholder="検索したい動画のキーワードを入力してください... (例: 最新技術トレンド)"
                    class="flex-grow p-3 border-2 border-indigo-600 bg-gray-700 text-white rounded-xl focus:ring-4 focus:ring-indigo-400 focus:border-indigo-400 transition duration-300 placeholder-gray-400"
                    onkeydown="if(event.key === 'Enter') searchVideos(this.value);"
                />
                <button
                    id="searchButton"
                    onclick="searchVideos(document.getElementById('searchInput').value)"
                    class="w-full md:w-auto px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl transition duration-300 ease-in-out shadow-lg transform hover:scale-[1.01] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                    <!-- アイコン: Lucide Search (SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <span>検索開始</span>
                </button>
            </div>
        </div>

        <!-- 検索結果エリア -->
        <main id="resultsContainer" class="mt-12 max-w-6xl mx-auto">
            <!-- 結果はこのコンテナ内にJavaScriptで動的に挿入されます -->
            <div class="text-center p-12 bg-gray-800 rounded-xl max-w-2xl mx-auto border-4 border-dashed border-indigo-700/50">
                <p class="text-2xl text-gray-300 font-light">
                    動画を検索するには、上のバーにキーワードを入力してください。
                </p>
            </div>
        </main>

        <!-- フッター -->
        <footer class="mt-16 text-center text-gray-500 text-sm">
            <p>&copy; 2025 Video Info Search UI. Built for GitHub Deployment.</p>
        </footer>
    </div>

    <script>
        // APIの設定
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        // APIキーはCanvas環境によって自動的に提供されます
        const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;

        // 状態管理のためのグローバル変数
        let isLoading = false;
        let selectedUri = null;
        let currentSummaryText = null;

        const resultsContainer = document.getElementById('resultsContainer');
        const searchButton = document.getElementById('searchButton');

        /**
         * UIの状態を更新し、ボタンのテキストと無効状態を切り替える
         * @param loadingState 新しいローディング状態 (true/false)
         * @param buttonText ボタンに表示するテキスト
         */
        function updateUIState(loadingState, buttonText = '検索開始') {
            isLoading = loadingState;
            searchButton.disabled = loadingState;
            searchButton.querySelector('span').textContent = buttonText;
        }

        /**
         * 検索結果のリストをレンダリングする
         * @param results 検索結果の配列
         */
        function renderResults(results) {
            resultsContainer.innerHTML = ''; // コンテナをクリア

            if (results.length === 0) {
                // 結果なしメッセージ
                const noResults = `
                    <div class="text-center p-8 bg-gray-800 rounded-xl max-w-xl mx-auto border border-gray-700">
                        <p class="text-xl text-yellow-500 font-semibold mb-2">検索結果が見つかりませんでした。</p>
                        <p class="text-gray-400">検索キーワードを変更して再度お試しください。</p>
                    </div>
                `;
                resultsContainer.innerHTML = noResults;
                return;
            }

            // 結果カードを格納するグリッドコンテナ
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';

            results.forEach(result => {
                const card = document.createElement('div');
                card.id = `card-${result.uri.replace(/[^a-zA-Z0-9]/g, '-')}`; // URIから安全なIDを生成

                const isSelected = selectedUri === result.uri;
                const buttonText = isSelected ? '解説を閉じる' : 'AIによる詳細な解説を取得';
                const summaryHtml = isSelected ? renderSummaryPanel(result) : '';

                card.innerHTML = `
                    <!-- サムネイル画像 -->
                    <div class="aspect-video bg-gray-700 flex items-center justify-center">
                        <img
                            src="${result.thumbnailUrl}"
                            alt="${result.title}のサムネイル"
                            class="w-full h-full object-cover"
                            onerror="this.onerror=null;this.src='https://placehold.co/600x338/374151/9CA3AF?text=Video+Thumbnail';"
                        />
                    </div>

                    <div class="p-5">
                        <!-- タイトル -->
                        <h3 class="text-xl font-bold text-white mb-2 line-clamp-2">
                            <a href="${result.uri}" target="_blank" class="hover:text-indigo-400 transition-colors">
                                ${result.title}
                            </a>
                        </h3>
                        <!-- スニペット -->
                        <p class="text-gray-400 text-sm mb-3 line-clamp-3">
                            ${result.snippet}
                        </p>
                        
                        <!-- アクションボタン -->
                        <div class="flex flex-col space-y-2 mt-4">
                            <a
                                href="${result.uri}"
                                target="_blank"
                                class="inline-flex items-center justify-center w-full px-4 py-2 text-indigo-400 border border-indigo-500 hover:bg-indigo-700/30 hover:text-white rounded-lg transition-colors text-sm font-medium"
                            >
                                <!-- アイコン: Lucide External Link (SVG) -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link mr-1"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>
                                YouTubeで動画を開く
                            </a>
                            <!-- 修正: onclick属性の引数をJSON.stringify()で安全にエスケープ -->
                            <button
                                onclick="toggleSummary(${JSON.stringify(result.uri)}, ${JSON.stringify(result.title)})"
                                id="summaryBtn-${card.id}"
                                class="w-full px-4 py-2 bg-pink-600 hover:bg-pink-500 text-white font-semibold rounded-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center gap-1"
                            >
                                <!-- アイコン: Lucide Brain Circuit (SVG) -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain-circuit"><path d="M12 5a3 3 0 1 0-7.35 1.77 8.9 8.9 0 0 0 7.35 14.23 8.9 8.9 0 0 0 7.35-14.23A3 3 0 1 0 12 5"/><path d="M12 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M12 17a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M12 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M16 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M8 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M16 17a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M8 17a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M16 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M8 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span>${buttonText}</span>
                            </button>
                        </div>
                    </div>
                    ${summaryHtml}
                `;
                grid.appendChild(card);
            });

            resultsContainer.appendChild(grid);
        }

        /**
         * 要約パネルのHTMLをレンダリングする
         * @param result 要約対象の動画情報
         */
        function renderSummaryPanel(result) {
            const isSelected = selectedUri === result.uri;
            if (!isSelected) return '';
            
            let content = '';
            if (isLoading) {
                // 要約取得中のローディング表示
                content = `
                    <div class="text-center text-pink-400 p-4">
                        <div class="animate-pulse">動画内容を分析中です...</div>
                    </div>
                `;
            } else if (currentSummaryText) {
                // 取得済みの要約を表示
                // preタグとwhitespace-pre-wrapで改行や箇条書きを保持
                content = `<pre class="text-gray-200 whitespace-pre-wrap font-sans text-sm">${currentSummaryText}</pre>`;
            } else {
                // エラーメッセージなど
                content = `<p class="text-red-400">要約の取得に失敗しました。</p>`;
            }

            return `
                <div id="summaryPanel-${result.uri.replace(/[^a-zA-Z0-9]/g, '-')}" class="p-5 bg-gray-700/50 border-t border-gray-600 transition-all duration-500">
                    <h4 class="text-lg font-bold text-pink-300 mb-3 flex items-center gap-2">
                        <!-- アイコン: Lucide Gem (SVG) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gem"><path d="M6 3v18l6-4 6 4V3l-6 4z"/></svg>
                        AIによる詳細解説
                    </h4>
                    ${content}
                </div>
            `;
        }

        /**
         * API呼び出しの共通ロジック (Exponential Backoff付き)
         * @param payload APIに送信するペイロード
         * @returns APIレスポンスのJSON
         */
        async function fetchWithRetry(payload) {
            let attempts = 0;
            const maxAttempts = 3;
            const apiKey = typeof __initial_auth_token !== 'undefined' ? '' : ''; // 環境からAPIキーを取得

            while (attempts < maxAttempts) {
                try {
                    const url = `${API_URL_BASE}?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else {
                        // 4xx, 5xxエラー
                        if (attempts === maxAttempts - 1) throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    if (attempts === maxAttempts - 1) throw error;
                }

                // Exponential Backoff
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempts) * 1000));
                attempts++;
            }
            throw new Error("API呼び出しが最大試行回数を超えて失敗しました。");
        }

        /**
         * 検索メイン関数
         * @param query ユーザーの検索クエリ
         */
        async function searchVideos(query) {
            const trimmedQuery = query.trim();
            if (!trimmedQuery) {
                // 検索バーが空の場合、検索結果を初期状態に戻す
                resultsContainer.innerHTML = `
                    <div class="text-center p-12 bg-gray-800 rounded-xl max-w-2xl mx-auto border-4 border-dashed border-indigo-700/50">
                        <p class="text-2xl text-gray-300 font-light">
                            動画を検索するには、上のバーにキーワードを入力してください。
                        </p>
                    </div>
                `;
                return;
            }

            // ローディング開始
            resultsContainer.innerHTML = `
                <div class="text-center text-indigo-400">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-400 border-t-transparent rounded-full" role="status"></div>
                    <p class="mt-2">情報を検索しています。少々お待ちください...</p>
                </div>
            `;
            updateUIState(true, '検索中...');
            selectedUri = null; // 要約パネルを閉じる

            const searchQueries = [`YouTube ${trimmedQuery}`, trimmedQuery];
            
            const systemPrompt = "You are a specialized search agent. When searching for video content, prioritize results from YouTube. Summarize the content from the search results, ensuring the URI, Title, and a short Snippet are provided for each result, focusing only on video results.";
            const userQuery = `Find recent YouTube videos or information related to: "${trimmedQuery}". Provide a structured JSON array containing the top 5 results with the following schema, ensuring 'youtube' is in the URI: [{"title": string, "uri": string, "snippet": string, "source": string, "thumbnailUrl": string}]`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": { queries: searchQueries } }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING", "description": "The video title." },
                                "uri": { "type": "STRING", "description": "The URL of the video (must contain 'youtube')." },
                                "snippet": { "type": "STRING", "description": "A brief description of the video content." },
                                "source": { "type": "STRING", "description": "The source domain (e.g., youtube.com)." },
                                "thumbnailUrl": { "type": "STRING", "description": "A placeholder image URL like https://placehold.co/600x338/374151/9CA3AF?text=Video+Thumbnail" }
                            },
                            required: ["title", "uri", "snippet", "source", "thumbnailUrl"]
                        }
                    }
                }
            };

            try {
                const jsonResponse = await fetchWithRetry(payload);
                
                const rawJsonString = jsonResponse.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rawJsonString) throw new Error("API response text is empty.");

                let parsedResults = JSON.parse(rawJsonString);

                const filteredResults = parsedResults
                    .filter(item => item.uri && item.uri.includes('youtube'))
                    .map(item => ({
                        title: item.title,
                        uri: item.uri,
                        snippet: item.snippet,
                        source: item.source || 'youtube.com',
                        thumbnailUrl: item.thumbnailUrl || 'https://placehold.co/600x338/374151/9CA3AF?text=Video+Thumbnail',
                    }));

                renderResults(filteredResults);

            } catch (error) {
                console.error("検索中にエラーが発生しました:", error);
                const errorMsg = `
                    <div class="text-center p-8 bg-gray-800 rounded-xl max-w-xl mx-auto border border-red-700">
                        <p class="text-xl text-red-500 font-semibold mb-2">エラーが発生しました</p>
                        <p class="text-gray-400">検索APIの呼び出し中に問題が発生しました。コンソールを確認してください。</p>
                    </div>
                `;
                resultsContainer.innerHTML = errorMsg;
            } finally {
                updateUIState(false);
            }
        }

        /**
         * AIによる要約を取得する
         * @param uri 要約対象のURI
         * @param title 要約対象のタイトル
         */
        async function getSummary(uri, title) {
            const summaryPanel = document.getElementById(`summaryPanel-${uri.replace(/[^a-zA-Z0-9]/g, '-')}`);
            if (!summaryPanel) return;

            // ローディングUIを表示
            summaryPanel.innerHTML = `
                <h4 class="text-lg font-bold text-pink-300 mb-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gem"><path d="M6 3v18l6-4 6 4V3l-6 4z"/></svg>
                    AIによる詳細解説
                </h4>
                <div class="text-center text-pink-400 p-4">
                    <div class="animate-pulse">動画内容を分析中です...</div>
                </div>
            `;
            
            const systemPrompt = "You are a professional summarization assistant. Your task is to find the content of a specific YouTube video based on its title and URL, and provide a detailed, itemized analysis in Japanese, detailing the main points and topic. Use bullet points for clear explanation. Do not include external links or disclaimers in the final output.";

            // ユーザーのリクエストを具体的に記述（詳細な箇条書きを要求）
            const userQuery = `以下のYouTube動画の内容をGoogle Searchで探して、その動画がどのような内容か、要点を5つ以上の箇条書きで日本語で詳細に解説してください。\n\n動画タイトル: ${title}\n動画URL: ${uri}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const jsonResponse = await fetchWithRetry(payload);

                const generatedText = jsonResponse?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    currentSummaryText = generatedText;
                } else {
                    currentSummaryText = "動画の内容を要約できませんでした。情報が見つからない可能性があります。";
                }
            } catch (error) {
                console.error("要約取得中にエラーが発生しました:", error);
                currentSummaryText = "通信エラーが発生しました。時間を置いて再度お試しください。";
            }
            
            // 要約が完了したらUIを更新（ボタンのテキストも更新）
            renderSummaryPanelUpdate(uri, title);
        }

        /**
         * 要約取得後のパネルを再描画する
         */
        function renderSummaryPanelUpdate(uri, title) {
            const summaryPanel = document.getElementById(`summaryPanel-${uri.replace(/[^a-zA-Z0-9]/g, '-')}`);
            const summaryBtn = document.getElementById(`summaryBtn-card-${uri.replace(/[^a-zA-Z0-9]/g, '-')}`);
            if (!summaryPanel || !summaryBtn) return;
            
            summaryPanel.innerHTML = `
                <h4 class="text-lg font-bold text-pink-300 mb-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gem"><path d="M6 3v18l6-4 6 4V3l-6 4z"/></svg>
                    AIによる詳細解説
                </h4>
                <pre class="text-gray-200 whitespace-pre-wrap font-sans text-sm">${currentSummaryText}</pre>
            `;
            summaryBtn.querySelector('span').textContent = '解説を閉じる';
        }

        /**
         * 要約パネルの表示/非表示を切り替える
         * @param uri クリックされた動画のURI
         * @param title クリックされた動画のタイトル
         */
        async function toggleSummary(uri, title) {
            if (selectedUri === uri) {
                // 既に開いている場合は閉じる
                selectedUri = null;
                currentSummaryText = null;
                
                // ボタンのテキストをリセット
                const summaryBtn = document.getElementById(`summaryBtn-card-${uri.replace(/[^a-zA-Z0-9]/g, '-')}`);
                if (summaryBtn) summaryBtn.querySelector('span').textContent = 'AIによる詳細な解説を取得';

                // パネルをDOMから削除
                const summaryPanel = document.getElementById(`summaryPanel-${uri.replace(/[^a-zA-Z0-9]/g, '-')}`);
                if (summaryPanel) summaryPanel.remove();
                
            } else {
                // 新しい要約を取得するために開く
                const previousUri = selectedUri;
                
                // 前に開いていたパネルを閉じる処理
                if (previousUri) {
                    const prevPanel = document.getElementById(`summaryPanel-${previousUri.replace(/[^a-zA-Z0-9]/g, '-')}`);
                    if (prevPanel) prevPanel.remove();
                    const prevBtn = document.getElementById(`summaryBtn-card-${previousUri.replace(/[^a-zA-Z0-9]/g, '-')}`);
                    if (prevBtn) prevBtn.querySelector('span').textContent = 'AIによる詳細な解説を取得';
                }

                selectedUri = uri;
                currentSummaryText = null;

                // 新しい要約パネルを挿入（ローディング状態）
                const card = document.getElementById(`card-${uri.replace(/[^a-zA-Z0-9]/g, '-')}`);
                if (card) {
                    card.insertAdjacentHTML('beforeend', renderSummaryPanel({ uri }));
                }

                // ボタンのテキストを更新
                const summaryBtn = document.getElementById(`summaryBtn-card-${uri.replace(/[^a-zA-Z0-9]/g, '-')}`);
                if (summaryBtn) summaryBtn.querySelector('span').textContent = '解説を閉じる';

                // API呼び出しと要約の取得
                await getSummary(uri, title);
            }
        }

        // 初期ロード時に何もしない
        window.onload = function() {
             // コンソールにログを出力
             console.log("動画情報検索UIが起動しました。");
        };

    </script>
</body>
</html>
